<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dark Chatbot Builder Pro</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Quill WYSIWYG Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #6f42c1;
      --secondary-color: #20c997;
      --accent-color: #fd7e14;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --success-color: #198754;
    }

    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .navbar {
      background: rgba(255, 255, 255, 0.1) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      border: none;
    }

    .btn-accent {
      background: linear-gradient(45deg, var(--accent-color), var(--warning-color));
      border: none;
      color: white;
    }

    .chatbot-preview {
      max-height: 400px;
      overflow-y: auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px;
    }

    .chat-message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 15px;
      max-width: 80%;
      animation: slideIn 0.3s ease;
    }

    .chat-message.user {
      background: var(--primary-color);
      margin-left: auto;
      text-align: right;
    }

    .chat-message.bot {
      background: var(--secondary-color);
      margin-right: auto;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .trigger-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .trigger-item:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--primary-color);
    }

    .response-type-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .response-type-btn {
      padding: 15px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .response-type-btn:hover,
    .response-type-btn.active {
      border-color: var(--primary-color);
      background: rgba(111, 66, 193, 0.2);
    }

    .csv-preview {
      max-height: 200px;
      overflow: auto;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .floating-action {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }

    .stats-card {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .ql-editor {
      background: rgba(255, 255, 255, 0.05);
      color: white;
      border-radius: 5px;
    }

    .ql-toolbar {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px 5px 0 0;
    }

    .file-drop-zone {
      border: 2px dashed var(--primary-color);
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .file-drop-zone:hover,
    .file-drop-zone.drag-over {
      background: rgba(111, 66, 193, 0.1);
      border-color: var(--secondary-color);
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
  </style>
</head>

<body>
  <!-- Toast Container -->
  <div class="toast-container"></div>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-robot text-primary"></i>
        <strong>Dark Chatbot Builder Pro</strong>
      </a>
      <div class="navbar-nav ms-auto">
        <button class="btn btn-outline-primary me-2" onclick="exportData()">
          <i class="bi bi-download"></i> Export </button>
        <button class="btn btn-outline-secondary me-2" onclick="importData()">
          <i class="bi bi-upload"></i> Import </button>
        <button class="btn btn-accent" onclick="clearAllData()">
          <i class="bi bi-trash"></i> Clear All </button>
      </div>
    </div>
  </nav>
  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Left Panel - Builder -->
      <div class="col-lg-8">
        <!-- Stats Cards -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card stats-card text-white">
              <div class="card-body text-center">
                <h4 id="triggerCount">0</h4>
                <small>Triggers</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-success text-white">
              <div class="card-body text-center">
                <h4 id="responseCount">0</h4>
                <small>Responses</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-warning text-white">
              <div class="card-body text-center">
                <h4 id="csvCount">0</h4>
                <small>CSV Files</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card bg-info text-white">
              <div class="card-body text-center">
                <h4 id="templateCount">0</h4>
                <small>Templates</small>
              </div>
            </div>
          </div>
        </div>
        <!-- Add New Trigger Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-plus-circle text-primary"></i> Add New Trigger</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Trigger Phrase</label>
                <input type="text" id="triggerInput" class="form-control"
                  placeholder="e.g., hello, contact info, get quote">
              </div>
              <div class="col-md-6">
                <label class="form-label">Category (Optional)</label>
                <select id="categorySelect" class="form-select">
                  <option value="">Select or type new...</option>
                  <option value="greeting">Greeting</option>
                  <option value="contact">Contact</option>
                  <option value="product">Product</option>
                  <option value="support">Support</option>
                </select>
              </div>
            </div>
            <!-- Response Type Selector -->
            <div class="mt-3">
              <label class="form-label">Response Type</label>
              <div class="response-type-selector">
                <div class="response-type-btn" data-type="text">
                  <i class="bi bi-chat-text-fill"></i><br>
                  <small>Text</small>
                </div>
                <div class="response-type-btn" data-type="url">
                  <i class="bi bi-link-45deg"></i><br>
                  <small>URL</small>
                </div>
                <div class="response-type-btn" data-type="document">
                  <i class="bi bi-file-earmark"></i><br>
                  <small>Document</small>
                </div>
                <div class="response-type-btn" data-type="email">
                  <i class="bi bi-envelope"></i><br>
                  <small>Email</small>
                </div>
                <div class="response-type-btn" data-type="quote">
                  <i class="bi bi-receipt"></i><br>
                  <small>Quote</small>
                </div>
                <div class="response-type-btn" data-type="csv">
                  <i class="bi bi-table"></i><br>
                  <small>CSV Data</small>
                </div>
              </div>
            </div>
            <!-- Dynamic Response Content -->
            <div id="responseContent" class="mt-3" style="display: none;">
              <!-- Content will be dynamically generated based on response type -->
            </div>
            <div class="mt-3">
              <button class="btn btn-primary me-2" onclick="addTrigger()">
                <i class="bi bi-plus"></i> Add Trigger </button>
              <button class="btn btn-secondary" onclick="clearForm()">
                <i class="bi bi-x"></i> Clear Form </button>
            </div>
          </div>
        </div>
        <!-- Existing Triggers -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="bi bi-list-ul text-secondary"></i> Existing Triggers</h5>
            <div>
              <input type="text" id="searchTriggers" class="form-control form-control-sm"
                placeholder="Search triggers..." style="width: 200px;">
            </div>
          </div>
          <div class="card-body">
            <div id="triggersList">
              <div class="text-center text-muted py-4">
                <i class="bi bi-robot" style="font-size: 3rem;"></i>
                <p>No triggers created yet. Add your first trigger above!</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Right Panel - Preview & Tools -->
      <div class="col-lg-4">
        <!-- Chatbot Preview -->
        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-eye text-info"></i> Live Preview</h5>
          </div>
          <div class="card-body">
            <div class="chatbot-preview" id="chatPreview">
              <div class="chat-message bot">
                <strong>Bot:</strong> Hello! I'm your chatbot. Try typing a trigger phrase below.
              </div>
            </div>
            <div class="input-group mt-3">
              <input type="text" id="previewInput" class="form-control" placeholder="Type a message...">
              <button class="btn btn-primary" onclick="sendPreviewMessage()">
                <i class="bi bi-send"></i>
              </button>
            </div>
            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearChat()">
              <i class="bi bi-trash"></i> Clear Chat </button>
          </div>
        </div>
        <!-- CSV Manager -->
        <div class="card mb-4">
          <div class="card-header">
            <h5><i class="bi bi-filetype-csv text-warning"></i> CSV Manager</h5>
          </div>
          <div class="card-body">
            <div class="file-drop-zone" onclick="document.getElementById('csvUpload').click()">
              <i class="bi bi-cloud-upload" style="font-size: 2rem;"></i>
              <p class="mb-0">Drop CSV files here or click to upload</p>
              <small class="text-muted">Supports: contacts, vehicles, quotes</small>
            </div>
            <input type="file" id="csvUpload" accept=".csv" style="display: none;" multiple>
            <div id="csvList" class="mt-3">
              <!-- CSV files will be listed here -->
            </div>
          </div>
        </div>
        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <h5><i class="bi bi-lightning-charge text-accent"></i> Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary" onclick="addSampleData()">
                <i class="bi bi-database-add"></i> Add Sample Data </button>
              <button class="btn btn-outline-success" onclick="validateBot()">
                <i class="bi bi-check-circle"></i> Validate Bot </button>
              <button class="btn btn-outline-info" onclick="showStats()">
                <i class="bi bi-graph-up"></i> Show Statistics </button>
              <button class="btn btn-outline-warning" onclick="optimizeBot()">
                <i class="bi bi-speedometer2"></i> Optimize Bot </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Floating Action Button -->
  <div class="floating-action">
    <button class="btn btn-primary rounded-circle pulse" onclick="scrollToTop()" title="Back to Top">
      <i class="bi bi-arrow-up"></i>
    </button>
  </div>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Quill WYSIWYG Editor -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    // Global variables
    let triggers = JSON.parse(localStorage.getItem('chatbotTriggers')) || [];
    let csvData = JSON.parse(localStorage.getItem('chatbotCSV')) || {};
    let currentResponseType = '';
    let emailEditor = null;
    let quoteEditor = null;

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function () {
      initializeApp();
      setupEventListeners();
      loadData();
      updateStats();
    });

    function initializeApp() {
      // Setup response type selector
      document.querySelectorAll('.response-type-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          selectResponseType(this.dataset.type);
        });
      });

      // Setup CSV upload
      const csvUpload = document.getElementById('csvUpload');
      csvUpload.addEventListener('change', handleCSVUpload);

      // Setup drag and drop for CSV
      const dropZone = document.querySelector('.file-drop-zone');
      dropZone.addEventListener('dragover', handleDragOver);
      dropZone.addEventListener('drop', handleDrop);
      dropZone.addEventListener('dragleave', handleDragLeave);

      // Setup search
      document.getElementById('searchTriggers').addEventListener('input', filterTriggers);

      // Setup preview input
      document.getElementById('previewInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          sendPreviewMessage();
        }
      });
    }

    function setupEventListeners() {
      // Auto-save functionality
      setInterval(function () {
        saveData();
      }, 30000); // Auto-save every 30 seconds

      // Window beforeunload
      window.addEventListener('beforeunload', function () {
        saveData();
      });
    }

    function selectResponseType(type) {
      currentResponseType = type;

      // Update UI
      document.querySelectorAll('.response-type-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`[data-type="${type}"]`).classList.add('active');

      // Generate response content form
      generateResponseForm(type);
    }

    function generateResponseForm(type) {
      const container = document.getElementById('responseContent');
      container.style.display = 'block';

      let html = '';

      switch (type) {
        case 'text':
          html = `
                        <label class="form-label">Response Text</label>
                        <textarea id="responseText" class="form-control" rows="3" placeholder="Enter your response text..."></textarea>
                    `;
          break;

        case 'url':
          html = `
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">URL</label>
                                <input type="url" id="responseUrl" class="form-control" placeholder="https://example.com">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Link Text</label>
                                <input type="text" id="responseLinkText" class="form-control" placeholder="Click here">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="openInNewTab">
                            <label class="form-check-label" for="openInNewTab">Open in new tab</label>
                        </div>
                    `;
          break;

        case 'document':
          html = `
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Document URL</label>
                                <input type="url" id="documentUrl" class="form-control" placeholder="Link to PDF, DOC, etc.">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Document Title</label>
                                <input type="text" id="documentTitle" class="form-control" placeholder="Document name">
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="embedDocument">
                            <label class="form-check-label" for="embedDocument">Embed document (if supported)</label>
                        </div>
                    `;
          break;

        case 'email':
          html = `
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Email Subject</label>
                                <input type="text" id="emailSubject" class="form-control" placeholder="Subject line">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Recipient (Optional)</label>
                                <input type="email" id="emailRecipient" class="form-control" placeholder="default@company.com">
                            </div>
                        </div>
                        <label class="form-label mt-3">Email Template</label>
                        <div id="emailEditor" style="height: 200px;"></div>
                    `;
          break;

        case 'quote':
          html = `
                        <label class="form-label">Quote Template</label>
                        <div id="quoteEditor" style="height: 200px;"></div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="useCSVData">
                            <label class="form-check-label" for="useCSVData">Use CSV data for calculations</label>
                        </div>
                    `;
          break;

        case 'csv':
          html = `
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">CSV File</label>
                                <select id="csvFileSelect" class="form-select">
                                    <option value="">Select CSV file...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Display Format</label>
                                <select id="csvDisplayFormat" class="form-select">
                                    <option value="table">Table</option>
                                    <option value="list">List</option>
                                    <option value="cards">Cards</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Search/Filter Column (Optional)</label>
                            <input type="text" id="csvFilterColumn" class="form-control" placeholder="e.g., name, company">
                        </div>
                    `;
          break;
      }

      container.innerHTML = html;

      // Initialize editors if needed
      setTimeout(() => {
        if (type === 'email' && !emailEditor) {
          emailEditor = new Quill('#emailEditor', {
            theme: 'snow',
            placeholder: 'Compose your email template...',
            modules: {
              toolbar: [
                ['bold', 'italic', 'underline'],
                ['link'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['clean']
              ]
            }
          });
        }

        if (type === 'quote' && !quoteEditor) {
          quoteEditor = new Quill('#quoteEditor', {
            theme: 'snow',
            placeholder: 'Create your quote template...',
            modules: {
              toolbar: [
                ['bold', 'italic', 'underline'],
                ['link'],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'header': [1, 2, 3, false] }],
                ['clean']
              ]
            }
          });
        }

        if (type === 'csv') {
          populateCSVSelect();
        }
      }, 100);
    }

    function populateCSVSelect() {
      const select = document.getElementById('csvFileSelect');
      if (!select) return;

      select.innerHTML = '<option value="">Select CSV file...</option>';

      Object.keys(csvData).forEach(filename => {
        const option = document.createElement('option');
        option.value = filename;
        option.textContent = filename;
        select.appendChild(option);
      });
    }

    function addTrigger() {
      const triggerText = document.getElementById('triggerInput').value.trim();
      const category = document.getElementById('categorySelect').value;

      if (!triggerText) {
        showToast('Please enter a trigger phrase', 'warning');
        return;
      }

      if (!currentResponseType) {
        showToast('Please select a response type', 'warning');
        return;
      }

      const responseData = gatherResponseData();
      if (!responseData) {
        showToast('Please fill in the response content', 'warning');
        return;
      }

      const trigger = {
        id: Date.now(),
        text: triggerText,
        category: category,
        responseType: currentResponseType,
        responseData: responseData,
        created: new Date().toISOString(),
        usage: 0
      };

      triggers.push(trigger);
      saveData();
      renderTriggers();
      updateStats();
      clearForm();

      showToast('Trigger added successfully!', 'success');
    }

    function gatherResponseData() {
      switch (currentResponseType) {
        case 'text':
          const text = document.getElementById('responseText').value.trim();
          return text ? { text } : null;

        case 'url':
          const url = document.getElementById('responseUrl').value.trim();
          const linkText = document.getElementById('responseLinkText').value.trim();
          const newTab = document.getElementById('openInNewTab').checked;
          return url ? { url, linkText: linkText || url, newTab } : null;

        case 'document':
          const docUrl = document.getElementById('documentUrl').value.trim();
          const docTitle = document.getElementById('documentTitle').value.trim();
          const embed = document.getElementById('embedDocument').checked;
          return docUrl ? { url: docUrl, title: docTitle || 'Document', embed } : null;

        case 'email':
          const subject = document.getElementById('emailSubject').value.trim();
          const recipient = document.getElementById('emailRecipient').value.trim();
          const content = emailEditor ? emailEditor.root.innerHTML : '';
          return subject ? { subject, recipient, content } : null;

        case 'quote':
          const quoteContent = quoteEditor ? quoteEditor.root.innerHTML : '';
          const useCSV = document.getElementById('useCSVData').checked;
          return quoteContent ? { content: quoteContent, useCSV } : null;

        case 'csv':
          const csvFile = document.getElementById('csvFileSelect').value;
          const displayFormat = document.getElementById('csvDisplayFormat').value;
          const filterColumn = document.getElementById('csvFilterColumn').value.trim();
          return csvFile ? { file: csvFile, displayFormat, filterColumn } : null;

        default:
          return null;
      }
    }

    function renderTriggers() {
      const container = document.getElementById('triggersList');

      if (triggers.length === 0) {
        container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-robot" style="font-size: 3rem;"></i>
                        <p>No triggers created yet. Add your first trigger above!</p>
                    </div>
                `;
        return;
      }

      const html = triggers.map(trigger => `
                <div class="trigger-item" data-id="${trigger.id}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-primary me-2">${trigger.responseType}</span>
                                ${trigger.category ? `<span class="badge bg-secondary me-2">${trigger.category}</span>` : ''}
                                <small class="text-muted">Used ${trigger.usage} times</small>
                            </div>
                            <h6 class="mb-1">"${trigger.text}"</h6>
                            <small class="text-muted">${getResponsePreview(trigger)}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editTrigger(${trigger.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="testTrigger(${trigger.id})" title="Test">
                                <i class="bi bi-play"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteTrigger(${trigger.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

      container.innerHTML = html;
    }

    function getResponsePreview(trigger) {
      const data = trigger.responseData;
      switch (trigger.responseType) {
        case 'text':
          return data.text.substring(0, 100) + (data.text.length > 100 ? '...' : '');
        case 'url':
          return `Link to: ${data.url}`;
        case 'document':
          return `Document: ${data.title}`;
        case 'email':
          return `Email: ${data.subject}`;
        case 'quote':
          return 'Quote template';
        case 'csv':
          return `CSV data from: ${data.file}`;
        default:
          return 'Unknown response type';
      }
    }

    function deleteTrigger(id) {
      if (confirm('Are you sure you want to delete this trigger?')) {
        triggers = triggers.filter(t => t.id !== id);
        saveData();
        renderTriggers();
        updateStats();
        showToast('Trigger deleted', 'info');
      }
    }

    function testTrigger(id) {
      const trigger = triggers.find(t => t.id === id);
      if (trigger) {
        simulateResponse(trigger.text);
      }
    }

    function sendPreviewMessage() {
      const input = document.getElementById('previewInput');
      const message = input.value.trim();

      if (!message) return;

      // Add user message
      addChatMessage(message, 'user');

      // Clear input
      input.value = '';

      // Find matching trigger
      simulateResponse(message);
    }

    function simulateResponse(userMessage) {
      const matchedTrigger = findMatchingTrigger(userMessage);

      if (matchedTrigger) {
        // Increment usage
        matchedTrigger.usage++;
        saveData();
        updateStats();

        // Generate response based on type
        const response = generateResponse(matchedTrigger);
        addChatMessage(response, 'bot');
      } else {
        addChatMessage("I'm sorry, I don't understand that. Try one of my programmed triggers!", 'bot');
      }
    }

    function findMatchingTrigger(message) {
      const lowerMessage = message.toLowerCase();
      return triggers.find(trigger => {
        const lowerTrigger = trigger.text.toLowerCase();
        return lowerMessage.includes(lowerTrigger) || lowerTrigger.includes(lowerMessage);
      });
    }

    function generateResponse(trigger) {
      const data = trigger.responseData;

      switch (trigger.responseType) {
        case 'text':
          return data.text;

        case 'url':
          return `<a href="${data.url}" ${data.newTab ? 'target="_blank"' : ''}>${data.linkText}</a>`;

        case 'document':
          return `<a href="${data.url}" target="_blank"><i class="bi bi-file-earmark"></i> ${data.title}</a>`;

        case 'email':
          const emailLink = `mailto:${data.recipient || ''}?subject=${encodeURIComponent(data.subject)}`;
          return `<a href="${emailLink}"><i class="bi bi-envelope"></i> Send Email: ${data.subject}</a>`;

        case 'quote':
          return `<div class="quote-response">${data.content}</div>`;

        case 'csv':
          return generateCSVResponse(data);

        default:
          return 'Response type not implemented yet.';
      }
    }

    function generateCSVResponse(data) {
      const csvContent = csvData[data.file];
      if (!csvContent || !csvContent.length) {
        return 'CSV data not found.';
      }

      switch (data.displayFormat) {
        case 'table':
          return generateCSVTable(csvContent);
        case 'list':
          return generateCSVList(csvContent);
        case 'cards':
          return generateCSVCards(csvContent);
        default:
          return 'Invalid display format.';
      }
    }

    function generateCSVTable(data) {
      if (!data.length) return 'No data available.';

      const headers = Object.keys(data[0]);
      let html = '<table class="table table-sm table-dark">';
      html += '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
      html += '<tbody>';

      data.slice(0, 5).forEach(row => { // Limit to 5 rows for preview
        html += '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>';
      });

      html += '</tbody></table>';
      if (data.length > 5) {
        html += `<small class="text-muted">Showing 5 of ${data.length} records</small>`;
      }

      return html;
    }

    function generateCSVList(data) {
      if (!data.length) return 'No data available.';

      return data.slice(0, 3).map(row => {
        const entries = Object.entries(row);
        return entries.map(([key, value]) => `<strong>${key}:</strong> ${value}`).join('<br>');
      }).join('<hr>') + (data.length > 3 ? `<br><small class="text-muted">And ${data.length - 3} more...</small>` : '');
    }

    function generateCSVCards(data) {
      if (!data.length) return 'No data available.';

      return data.slice(0, 2).map(row => {
        const entries = Object.entries(row);
        return `<div class="card card-sm mb-2">
                    <div class="card-body p-2">
                        ${entries.map(([key, value]) => `<div><small class="text-muted">${key}:</small> ${value}</div>`).join('')}
                    </div>
                </div>`;
      }).join('') + (data.length > 2 ? `<small class="text-muted">And ${data.length - 2} more...</small>` : '');
    }

    function addChatMessage(message, sender) {
      const chatPreview = document.getElementById('chatPreview');
      const messageDiv = document.createElement('div');
      messageDiv.className = `chat-message ${sender}`;
      messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'Bot'}:</strong> ${message}`;

      chatPreview.appendChild(messageDiv);
      chatPreview.scrollTop = chatPreview.scrollHeight;
    }

    function clearChat() {
      const chatPreview = document.getElementById('chatPreview');
      chatPreview.innerHTML = `
                <div class="chat-message bot">
                    <strong>Bot:</strong> Hello! I'm your chatbot. Try typing a trigger phrase below.
                </div>
            `;
    }

    function handleCSVUpload(event) {
      const files = event.target.files;
      for (let file of files) {
        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
          parseCSVFile(file);
        }
      }
    }

    function parseCSVFile(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const csv = e.target.result;
        const parsed = parseCSV(csv);
        csvData[file.name] = parsed;
        saveData();
        renderCSVList();
        updateStats();
        showToast(`CSV file "${file.name}" uploaded successfully!`, 'success');
      };
      reader.readAsText(file);
    }

    function parseCSV(csv) {
      const lines = csv.split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] || '';
          });
          data.push(row);
        }
      }

      return data;
    }

    function renderCSVList() {
      const container = document.getElementById('csvList');

      if (Object.keys(csvData).length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No CSV files uploaded yet.</p>';
        return;
      }

      const html = Object.entries(csvData).map(([filename, data]) => `
                <div class="csv-item mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${filename}</strong>
                            <br><small class="text-muted">${data.length} records</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-info" onclick="previewCSV('${filename}')" title="Preview">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteCSV('${filename}')" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

      container.innerHTML = html;
    }

    function previewCSV(filename) {
      const data = csvData[filename];
      if (!data || !data.length) return;

      let preview = `<strong>${filename}</strong> (${data.length} records)\n\n`;
      preview += generateCSVTable(data.slice(0, 3));

      showModal('CSV Preview', preview);
    }

    function deleteCSV(filename) {
      if (confirm(`Delete CSV file "${filename}"?`)) {
        delete csvData[filename];
        saveData();
        renderCSVList();
        updateStats();
        showToast('CSV file deleted', 'info');
      }
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      const files = e.dataTransfer.files;
      for (let file of files) {
        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
          parseCSVFile(file);
        }
      }
    }

    function filterTriggers() {
      const search = document.getElementById('searchTriggers').value.toLowerCase();
      const triggerItems = document.querySelectorAll('.trigger-item');

      triggerItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(search) ? 'block' : 'none';
      });
    }

    function clearForm() {
      document.getElementById('triggerInput').value = '';
      document.getElementById('categorySelect').value = '';
      document.querySelectorAll('.response-type-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById('responseContent').style.display = 'none';
      currentResponseType = '';

      // Reset editors
      if (emailEditor) {
        emailEditor.setContents([]);
      }
      if (quoteEditor) {
        quoteEditor.setContents([]);
      }
    }

    function updateStats() {
      document.getElementById('triggerCount').textContent = triggers.length;
      document.getElementById('responseCount').textContent = triggers.length;
      document.getElementById('csvCount').textContent = Object.keys(csvData).length;

      const templateCount = triggers.filter(t => t.responseType === 'email' || t.responseType === 'quote').length;
      document.getElementById('templateCount').textContent = templateCount;
    }

    function saveData() {
      localStorage.setItem('chatbotTriggers', JSON.stringify(triggers));
      localStorage.setItem('chatbotCSV', JSON.stringify(csvData));
    }

    function loadData() {
      renderTriggers();
      renderCSVList();
    }

    function exportData() {
      const exportData = {
        triggers: triggers,
        csvData: csvData,
        exportDate: new Date().toISOString(),
        version: '1.0'
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `chatbot-backup-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showToast('Data exported successfully!', 'success');
    }

    function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const data = JSON.parse(e.target.result);
              if (data.triggers && data.csvData) {
                triggers = data.triggers;
                csvData = data.csvData;
                saveData();
                loadData();
                updateStats();
                showToast('Data imported successfully!', 'success');
              } else {
                showToast('Invalid backup file format', 'danger');
              }
            } catch (error) {
              showToast('Error parsing backup file', 'danger');
            }
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function clearAllData() {
      if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
        triggers = [];
        csvData = {};
        saveData();
        loadData();
        updateStats();
        clearChat();
        showToast('All data cleared', 'warning');
      }
    }

    function addSampleData() {
      const sampleTriggers = [
        {
          id: Date.now() + 1,
          text: 'hello',
          category: 'greeting',
          responseType: 'text',
          responseData: { text: 'Hello! How can I help you today?' },
          created: new Date().toISOString(),
          usage: 0
        },
        {
          id: Date.now() + 2,
          text: 'contact',
          category: 'contact',
          responseType: 'text',
          responseData: { text: 'You can reach us at contact@company.com or call (555) 123-4567' },
          created: new Date().toISOString(),
          usage: 0
        },
        {
          id: Date.now() + 3,
          text: 'website',
          category: 'info',
          responseType: 'url',
          responseData: { url: 'https://example.com', linkText: 'Visit our website', newTab: true },
          created: new Date().toISOString(),
          usage: 0
        }
      ];

      triggers.push(...sampleTriggers);
      saveData();
      renderTriggers();
      updateStats();
      showToast('Sample data added!', 'success');
    }

    function validateBot() {
      const issues = [];

      if (triggers.length === 0) {
        issues.push('No triggers defined');
      }

      const duplicateTriggers = triggers.filter((t1, i) =>
        triggers.findIndex(t2 => t2.text.toLowerCase() === t1.text.toLowerCase()) !== i
      );

      if (duplicateTriggers.length > 0) {
        issues.push(`Duplicate triggers found: ${duplicateTriggers.map(t => t.text).join(', ')}`);
      }

      const csvTriggers = triggers.filter(t => t.responseType === 'csv');
      csvTriggers.forEach(trigger => {
        if (!csvData[trigger.responseData.file]) {
          issues.push(`CSV file not found: ${trigger.responseData.file}`);
        }
      });

      if (issues.length === 0) {
        showToast('✅ Bot validation passed!', 'success');
      } else {
        showModal('Validation Issues', issues.map(issue => `• ${issue}`).join('<br>'));
      }
    }

    function showStats() {
      const totalUsage = triggers.reduce((sum, t) => sum + t.usage, 0);
      const avgUsage = triggers.length > 0 ? (totalUsage / triggers.length).toFixed(1) : 0;
      const mostUsed = triggers.reduce((max, t) => t.usage > max.usage ? t : max, { usage: 0, text: 'None' });

      const stats = `
                <strong>Bot Statistics:</strong><br><br>
                • Total Triggers: ${triggers.length}<br>
                • Total Usage: ${totalUsage}<br>
                • Average Usage: ${avgUsage}<br>
                • Most Used: "${mostUsed.text}" (${mostUsed.usage} times)<br>
                • CSV Files: ${Object.keys(csvData).length}<br>
                • Categories: ${[...new Set(triggers.map(t => t.category).filter(c => c))].length}
            `;

      showModal('Statistics', stats);
    }

    function optimizeBot() {
      let optimizations = [];

      // Find unused triggers
      const unused = triggers.filter(t => t.usage === 0);
      if (unused.length > 0) {
        optimizations.push(`${unused.length} triggers have never been used`);
      }

      // Find similar triggers
      const similar = [];
      for (let i = 0; i < triggers.length; i++) {
        for (let j = i + 1; j < triggers.length; j++) {
          const similarity = calculateSimilarity(triggers[i].text, triggers[j].text);
          if (similarity > 0.7) {
            similar.push(`"${triggers[i].text}" and "${triggers[j].text}" are very similar`);
          }
        }
      }

      if (similar.length > 0) {
        optimizations.push(...similar);
      }

      if (optimizations.length === 0) {
        showToast('🚀 Bot is already optimized!', 'success');
      } else {
        showModal('Optimization Suggestions', optimizations.map(opt => `• ${opt}`).join('<br>'));
      }
    }

    function calculateSimilarity(str1, str2) {
      const longer = str1.length > str2.length ? str1 : str2;
      const shorter = str1.length > str2.length ? str2 : str1;

      if (longer.length === 0) return 1.0;

      return (longer.length - editDistance(longer, shorter)) / longer.length;
    }

    function editDistance(str1, str2) {
      const matrix = [];

      for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
      }

      for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
      }

      for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
          if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }

      return matrix[str2.length][str1.length];
    }

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    function showModal(title, content) {
      // Create modal if it doesn't exist
      let modal = document.getElementById('dynamicModal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'dynamicModal';
        modal.className = 'modal fade';
        modal.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content bg-dark">
                            <div class="modal-header">
                                <h5 class="modal-title"></h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body"></div>
                        </div>
                    </div>
                `;
        document.body.appendChild(modal);
      }

      modal.querySelector('.modal-title').textContent = title;
      modal.querySelector('.modal-body').innerHTML = content;

      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    }
  </script>
</body>

</html>